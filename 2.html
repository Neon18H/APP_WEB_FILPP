<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Clientes • Supabase</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light dark">
</head>
<body class="min-h-screen bg-gray-50 text-gray-900">
  <div class="max-w-6xl mx-auto px-4 py-8">
    <header class="mb-6">
      <h1 class="text-2xl font-bold">Panel de Clientes</h1>
      <p class="text-sm text-gray-600">Login + listado desde <code>clients</code> + carga de documentos</p>
    </header>

    <!-- Login -->
    <section id="loginPanel" class="mb-6 border border-gray-200 rounded-xl bg-white p-4 shadow-sm">
      <h2 class="font-semibold mb-3">Ingresar</h2>
      <form id="loginForm" class="grid gap-3 sm:grid-cols-3">
        <input id="email" type="email" placeholder="Email" required class="border rounded-lg px-3 py-2">
        <input id="password" type="password" placeholder="Contraseña" required class="border rounded-lg px-3 py-2">
        <button class="rounded-lg px-4 py-2 bg-indigo-600 text-white hover:bg-indigo-700">Entrar</button>
      </form>
    </section>

    <!-- Sesión -->
    <section id="sessionBar" class="hidden mb-6 border border-gray-200 rounded-xl bg-white p-4 shadow-sm flex items-center justify-between">
      <div>Sesión: <span id="whoami" class="font-medium"></span></div>
      <button id="logoutBtn" class="rounded-lg px-3 py-1 border">Salir</button>
    </section>

    <!-- Avisos -->
    <div id="toast" class="hidden mb-4 rounded-lg border px-4 py-3 text-sm"></div>

    <!-- Clientes -->
    <section id="clientsGrid" class="hidden grid gap-4 sm:grid-cols-2 lg:grid-cols-3"></section>
    <div id="emptyState" class="hidden border border-gray-200 rounded-xl bg-white p-6 text-center text-gray-600">No hay clientes para mostrar.</div>

    <!-- Loader -->
    <div id="loader" class="hidden flex justify-center py-10">
      <svg class="animate-spin h-6 w-6 text-indigo-600" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
      </svg>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/+esm";

    // ========= CONFIG =========
    const SUPABASE_URL = "https://kswpgfomoakhmarbgfob.supabase.co"; // <-- cambia esto
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtzd3BnZm9tb2FraG1hcmJnZm9iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MzM3MDksImV4cCI6MjA3NjEwOTcwOX0.LFfx3lAvc5cy9S9XCshPkwrrh9oWdSiNyUIFPMG9y2E";                 // <-- y esto
    const CLIENTS_TABLE = "clients";
    const BUCKET = "client_docs";

    // ========= INIT =========
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // UI helpers
    const $ = (s) => document.querySelector(s);
    const loginPanel = $("#loginPanel");
    const sessionBar = $("#sessionBar");
    const whoami = $("#whoami");
    const grid = $("#clientsGrid");
    const emptyState = $("#emptyState");
    const toast = $("#toast");
    const loader = $("#loader");

    function setLoading(v){ loader.classList.toggle("hidden", !v); }
    function showToast(msg, kind="ok"){
      toast.textContent = msg;
      toast.classList.remove("hidden");
      toast.classList.toggle("border-green-300", kind==="ok");
      toast.classList.toggle("bg-green-50", kind==="ok");
      toast.classList.toggle("text-green-800", kind==="ok");
      toast.classList.toggle("border-red-300", kind==="err");
      toast.classList.toggle("bg-red-50", kind==="err");
      toast.classList.toggle("text-red-800", kind==="err");
      setTimeout(()=>toast.classList.add("hidden"), 3500);
    }
    function setUI(loggedIn){
      loginPanel.classList.toggle("hidden", loggedIn);
      sessionBar.classList.toggle("hidden", !loggedIn);
      grid.classList.toggle("hidden", !loggedIn);
      if (!loggedIn){ grid.innerHTML = ""; emptyState.classList.add("hidden"); }
    }

    // ========= DATA: clients =========
    async function listClients(){
      // Usa exactamente tus columnas reales
      const { data, error } = await supabase
        .from(CLIENTS_TABLE)
        .select("id, name, contact, tax_id, payment_state, declaration_status, payment_amount, created_at, due_date, notes")
        .order("created_at", { ascending: false });
      if (error) throw error;
      return data ?? [];
    }

    // ========= STORAGE: por cliente =========
    async function listDocsForClient(clientId){
      const { data, error } = await supabase.storage.from(BUCKET).list(clientId, { limit: 100 });
      if (error) throw error;
      return data ?? [];
    }
    async function uploadDoc(clientId, file){
      const filename = `${Date.now()}_${file.name.replace(/\\s+/g,"_")}`;
      const path = `${clientId}/${filename}`;
      const { error } = await supabase.storage.from(BUCKET).upload(path, file, { upsert: false });
      if (error) throw error;
      return path;
    }
    async function getSignedUrl(path){
      const { data, error } = await supabase.storage.from(BUCKET).createSignedUrl(path, 3600);
      if (error) throw error;
      return data?.signedUrl;
    }

    // Render
    function addDocLi(ul, name, url){
      const li = document.createElement("li");
      li.className = "text-sm";
      li.innerHTML = `<a class="text-indigo-600 hover:underline break-all" href="${url}" target="_blank">${name}</a>`;
      ul.appendChild(li);
    }
    async function loadDocsForCard(clientId, ul){
      try {
        const docs = await listDocsForClient(clientId);
        ul.innerHTML = "";
        if (!docs.length){
          ul.innerHTML = `<li class="text-gray-500">Sin documentos</li>`;
          return;
        }
        for (const d of docs){
          const url = await getSignedUrl(`${clientId}/${d.name}`);
          addDocLi(ul, d.name, url);
        }
      } catch (e) {
        ul.innerHTML = `<li class="text-red-600">Error listando documentos</li>`;
      }
    }

    function renderClients(clients){
      grid.innerHTML = "";
      if (!clients.length){ emptyState.classList.remove("hidden"); return; }
      emptyState.classList.add("hidden");

      for (const c of clients){
        const statusDecl = (c.declaration_status ?? "—").toString();
        const statusPay  = (c.payment_state ?? "—").toString();
        const due = c.due_date ? new Date(c.due_date).toLocaleDateString() : "—";
        const amount = c.payment_amount ?? "—";

        const card = document.createElement("article");
        card.className = "border border-gray-200 rounded-xl bg-white p-5 shadow-sm flex flex-col gap-4";
        card.innerHTML = `
          <div class="flex items-start justify-between gap-3">
            <div>
              <h3 class="font-semibold text-lg break-words">${c.name ?? `Cliente ${String(c.id).slice(0,6)}`}</h3>
              <p class="text-sm text-gray-600 break-words">
                Contacto: ${c.contact ?? "—"} · NIT/Tax: ${c.tax_id ?? "—"}
              </p>
              <p class="text-xs text-gray-500">
                Vence: ${due} · Monto: ${amount}
              </p>
              ${c.notes ? `<p class="text-xs text-gray-500 mt-1">Notas: ${c.notes}</p>` : ""}
            </div>
            <div class="text-right text-xs">
              <div class="inline-block rounded-full px-2 py-1 border ${statusDecl.toLowerCase().includes("ok") ? "border-green-300 bg-green-50 text-green-800" : "border-amber-300 bg-amber-50 text-amber-800"}">
                Declaración: ${statusDecl}
              </div>
              <div class="inline-block rounded-full px-2 py-1 border ml-2 ${statusPay.toLowerCase().includes("pag") || statusPay.toLowerCase()==="paid" ? "border-green-300 bg-green-50 text-green-800" : "border-amber-300 bg-amber-50 text-amber-800"}">
                Pago: ${statusPay}
              </div>
            </div>
          </div>

          <div class="flex items-center gap-2">
            <label class="cursor-pointer inline-flex items-center gap-2 border rounded-lg px-3 py-2 hover:bg-gray-50">
              <input type="file" class="hidden" />
              <span>Subir documento</span>
            </label>
            <div class="text-xs text-gray-500">Se guardará en <code>${BUCKET}/${c.id}/</code></div>
          </div>

          <div class="border-t pt-3">
            <h4 class="font-medium text-sm mb-2">Documentos</h4>
            <ul class="space-y-1" data-docs></ul>
          </div>
        `;

        // Upload
        const fileInput = card.querySelector('input[type=file]');
        fileInput.addEventListener("change", async (ev) => {
          const file = ev.target.files?.[0]; if (!file) return;
          try {
            setLoading(true);
            const path = await uploadDoc(c.id, file);
            showToast("Documento subido correctamente");
            const ul = card.querySelector('[data-docs]');
            const name = path.split("/").pop();
            const url  = await getSignedUrl(path);
            addDocLi(ul, name, url);
          } catch (e) {
            showToast(e.message || "Error al subir documento", "err");
          } finally {
            setLoading(false);
            fileInput.value = "";
          }
        });

        // Docs iniciales
        loadDocsForCard(c.id, card.querySelector('[data-docs]'));
        grid.appendChild(card);
      }
    }

    async function refresh(){
      try {
        setLoading(true);
        const rows = await listClients();
        renderClients(rows);
      } catch (e) {
        showToast(e.message || "Error al listar clientes", "err");
      } finally {
        setLoading(false);
      }
    }

    // ========= AUTH =========
    supabase.auth.onAuthStateChange(async (_event, session) => {
      if (session?.user){
        setUI(true);
        whoami.textContent = session.user.email || session.user.id;
        await refresh();
      } else {
        setUI(false);
      }
    });

    // Login/Logout
    document.querySelector("#loginForm")?.addEventListener("submit", async (ev) => {
      ev.preventDefault();
      try {
        setLoading(true);
        const email = $("#email").value.trim();
        const password = $("#password").value;
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) throw error;
      } catch (e) {
        showToast(e.message || "Error al iniciar sesión", "err");
      } finally {
        setLoading(false);
      }
    });
    document.querySelector("#logoutBtn")?.addEventListener("click", async () => {
      await supabase.auth.signOut();
      showToast("Sesión cerrada");
    });
  </script>
</body>
</html>
